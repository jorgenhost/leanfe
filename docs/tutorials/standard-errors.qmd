---
title: "Standard Errors"
subtitle: "IID, HC1, and clustered"
---

## Overview

This tutorial shows the standard error options available in `leanfe`.

All standard error types use **YOCO compression** from [Wong et al. (2021)](https://arxiv.org/abs/2102.11297) for blazing fast computation. For clustered SEs, leanfe implements Section 5.3.1 using **sparse matrices** for efficient cluster score aggregation.

## Options

| Type | Syntax | Description | YOCO Support |
|------|--------|-------------|--------------|
| IID | `vcov="iid"` | Homoskedastic errors | ✅ |
| HC1 | `vcov="HC1"` | Heteroskedasticity-robust | ✅ |
| Clustered | `vcov="cluster"` | Correlation within groups | ✅ (sparse matrix) |

## Example Data

```{python}
#| echo: true
#| output: true

import numpy as np
import polars as pl
from leanfe import leanfe

np.random.seed(42)
n_obs = 50_000

firm_id = np.random.randint(1, 101, n_obs)
year = np.random.randint(2015, 2025, n_obs)
treatment = np.random.binomial(1, 0.3, n_obs).astype(float)
x1 = np.random.normal(0, 1, n_obs)

# Heteroskedastic + clustered errors
error = np.random.normal(0, 0.5 + 0.5 * np.abs(x1)) + np.random.normal(0, 0.5, 101)[firm_id]

y = 2.5 * treatment + 1.5 * x1 + np.random.normal(0, 1, 101)[firm_id] + error

df = pl.DataFrame({
    "y": y, "treatment": treatment, "x1": x1, "firm_id": firm_id, "year": year
})

print(f"Data: {n_obs:,} obs, {df['firm_id'].n_unique()} firms")
```

## IID

```{python}
#| echo: true
#| output: true

result_iid = leanfe(data=df, formula="y ~ treatment + x1 | firm_id + year", vcov="iid")

print("IID:")
for var in ["treatment", "x1"]:
    print(f"  {var}: {result_iid['coefficients'][var]:.4f} (SE: {result_iid['std_errors'][var]:.4f})")
```

## HC1 (Robust)

```{python}
#| echo: true
#| output: true

result_hc1 = leanfe(data=df, formula="y ~ treatment + x1 | firm_id + year", vcov="HC1")

print("HC1:")
for var in ["treatment", "x1"]:
    print(f"  {var}: {result_hc1['coefficients'][var]:.4f} (SE: {result_hc1['std_errors'][var]:.4f})")
```

## Clustered

Clustered SEs use **YOCO + sparse matrix** (Section 5.3.1 of Wong et al. 2021) for efficient computation:

1. Within-cluster compression: cluster ID added to GROUP BY
2. Sparse cluster matrix W̃_C for vectorized score aggregation
3. No loops over clusters - pure matrix operations

```{python}
#| echo: true
#| output: true

result_cluster = leanfe(
    data=df,
    formula="y ~ treatment + x1 | firm_id + year",
    vcov="cluster",
    cluster_cols=["firm_id"]
)

print("Clustered (firm):")
for var in ["treatment", "x1"]:
    print(f"  {var}: {result_cluster['coefficients'][var]:.4f} (SE: {result_cluster['std_errors'][var]:.4f})")
print(f"Clusters: {result_cluster['n_clusters']}")
print(f"Strategy: {result_cluster.get('strategy', 'N/A')}")
```

## Two-Way Clustering

```{python}
#| echo: true
#| output: true

result_twoway = leanfe(
    data=df,
    formula="y ~ treatment + x1 | firm_id + year",
    vcov="cluster",
    cluster_cols=["firm_id", "year"]
)

print("Two-way (firm + year):")
for var in ["treatment", "x1"]:
    print(f"  {var}: {result_twoway['coefficients'][var]:.4f} (SE: {result_twoway['std_errors'][var]:.4f})")
```

## Comparison

```{python}
#| echo: true
#| output: true

print("SE comparison for 'treatment':")
print(f"  IID:       {result_iid['std_errors']['treatment']:.4f}")
print(f"  HC1:       {result_hc1['std_errors']['treatment']:.4f}")
print(f"  Clustered: {result_cluster['std_errors']['treatment']:.4f}")
print(f"  Two-way:   {result_twoway['std_errors']['treatment']:.4f}")
```

## Next Steps

- [DiD & Event Studies](did.qmd)
- [Large Datasets](../guides/large-datasets.qmd)
- [API Reference](../reference/python.qmd)
